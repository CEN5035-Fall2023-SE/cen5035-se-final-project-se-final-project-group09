<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/layout::head}"></head>

<nav th:replace="~{fragments/layout::navigation}"></nav>

<body>
    <div class="container">
        <div class="card my-5">
            <div class="card-header">
                <h2 class="text-center">Enrollment Form</h2>
            </div>
            <div class="card-body">
                <form class="" id="enroll-form" method="post" role="form" enctype="multipart/form-data"
                    th:action="@{/application/enroll/save}" th:object="${newApplication}">
                    <input type="hidden" name="applicant.id" th:value="${#authentication.principal.userDto.id}">
                    <!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-lg-auto">
                            <span class="fs-5">Applicant Details,</span>
                        </div>
                        <div class="col-lg">
                            <table class="table align-bottom table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold fs-6" style="width: 1%; white-space: nowrap;">Name:</td>
                                        <td class="display-6" th:text="${#authentication.principal.userDto.name}"></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold fs-6" style="width: 1%; white-space: nowrap;">Gender & Age:
                                        </td>
                                        <td class="fs-5"
                                            th:text="${#authentication.principal.userDto.gender + ' (' + #authentication.principal.userDto.age + 'y)'}">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold fs-6" style="width: 1%; white-space: nowrap;">E-mail:</td>
                                        <td class="small"><a class="text-reset fst-italic"
                                                th:href="${'mailto:' + #authentication.principal.userDto.email}"
                                                th:text="${#authentication.principal.userDto.email}"></a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg align-self-center">
                            <table class="table align-bottom table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold fs-6" style="width: 1%; white-space: nowrap;">Department:
                                        </td>
                                        <td class="fs-5" th:text="${#authentication.principal.userDto.department.name}">
                                        </td>
                                    </tr>
                                    <tr th:if="${#authentication.principal.userDto.role.name() != 'APPLICANT'}">
                                        <td class="fw-bold fs-6" style="width: 1%; white-space: nowrap;">Role:</td>
                                        <td class="fs-5"
                                            th:text="${#authentication.principal.userDto.role.description}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------->
                    <hr>
                    <div class="row">
                        <div class="col-md">
                            <div class="form-group mb-3">
                                <label class="form-label">Tell us why you want to apply?</label><br>
                                <textarea class="form-control" rows="5" maxlength="255" th:field="*{description}"
                                    placeholder="Give a breif..."></textarea>
                                <p th:errors="*{description}" class="text-danger"
                                    th:if="${#fields.hasErrors('description')}">
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label class="form-label">Select Courses</label><br>
                                <div class="btn-toolbar justify-content-md-center" role="toolbar">
                                    <div class="btn-group m-1" role="group" th:each="crs,itr : ${courses}"
                                        th:if="${crs.active}">
                                        <input type="checkbox" class="btn-check"
                                            th:checked="${#lists.contains(newApplication.coursesSelected, crs.id)}"
                                            th:id="${'coursesSelected' + itr.count}" name="coursesSelected"
                                            th:value="${crs.id}" autocomplete="off">
                                        <label class="btn btn-outline-secondary"
                                            th:for="${'coursesSelected' + itr.count}" th:text="${crs.name}"></label>
                                    </div>
                                </div>
                                <p th:errors="*{coursesSelected}" class="text-danger"
                                    th:if="${#fields.hasErrors('coursesSelected')}">
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Previous Experiances<br>
                            <small class="form-text fst-italic">(Only valid experiances are included!)</small>
                        </label><br>
                        <div class="form-group mb-1 p-2 border rounded" th:each="pe, itr : *{prevExp}"
                            th:id="${'prevexp' + itr.index}"
                            th:hidden="${pe.startDate == null && pe.endDate == null && (pe.description == null || pe.description == '')}">
                            <div class="row mb-3">
                                <label class="col-md-auto col-form-label">Start Date</label>
                                <div class="col-md-3">
                                    <input class="form-control" type="date"
                                        th:field="*{prevExp[__${itr.index}__].startDate}">
                                </div>
                                <label class="col-md-auto col-form-label">End Date</label>
                                <div class="col-md-3">
                                    <input class="form-control" type="date"
                                        th:field="*{prevExp[__${itr.index}__].endDate}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md">
                                    <textarea class="form-control" rows="2" placeholder="Give a breif..."
                                        maxlength="255" th:field="*{prevExp[__${itr.index}__].description}"></textarea>
                                </div>
                                <div class="col-md-auto">
                                    <button class="btn btn-secondary" th:id="${itr.index}" onclick="removePrevExpBtn(this)"
                                        type="button">Remove</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="addPrevExpBtn" onclick="adPrevExpBtn()" type="button">Add
                            Experiance</button>
                    </div>
                    <div class="form-group mb-3">
                        <label for="formFile" class="form-label">Upload CV<br>
                            <small class="form-text fst-italic">(Format: PDF, Max-Size: 2MB!)</small>
                        </label>
                        <input class="form-control" type="file" th:field="*{cvFile}" accept=".pdf,application/pdf"
                            onchange="validateSize(this)">
                        <p th:errors="*{cvFile}" class="text-danger" th:if="${#fields.hasErrors('cvFile')}">
                        </p>
                    </div>
                    <div class="row justify-content-center">
                        <button class="col-md-1 btn btn-primary" type="submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        function validateSize(input) {
            const fileSize = input.files[0].size / 1024 / 1024 / 8;
            if (fileSize > 2) {
                alert('File size exceeds 2 MB');
                input.value = '';
            }
        }
        function fixPrevExpBtn() {
            var prevExps = document.querySelectorAll("[id^='prevexp']")
            var addPrevExpBtn = document.getElementById('addPrevExpBtn')
            var anyHidden = false
            for (const pe of prevExps) {
                anyHidden |= pe.hidden
            }
            addPrevExpBtn.hidden = !anyHidden
        }
        function adPrevExpBtn() {
            var prevExps = document.querySelectorAll("[id^='prevexp']")
            var addPrevExpBtn = document.getElementById('addPrevExpBtn')
            for (var pe of prevExps) {
                if (pe.hidden) {
                    pe.hidden = false
                    break
                }
            }
            fixPrevExpBtn()
        }
        function removePrevExpBtn(btn) {
            document.getElementById('prevexp' + btn.id).hidden = true
            document.getElementById('prevExp' + btn.id + '.startDate').value = null
            document.getElementById('prevExp' + btn.id + '.endDate').value = null
            document.getElementById('prevExp' + btn.id + '.description').value = null
            fixPrevExpBtn()
        }
        fixPrevExpBtn()
    </script>

    <div th:replace="~{fragments/layout::bootstrap-script}"></div>
</body>

</html>